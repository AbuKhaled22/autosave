---
import PageLayout from '../../layouts/PageLayout.astro';
import { getContentByLanguage } from '../../lib/content';
import { getLocalizedPath } from '../../lib/i18n';
import { blogPosts, getBlogPost, getRelatedPosts } from '../../lib/blog-data';

const lang = 'ar' as const;
const content = getContentByLanguage(lang);
const blogContent = content.blog.post;

export function getStaticPaths() {
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = getBlogPost(slug, lang);

if (!post) {
  return Astro.redirect('/404');
}

const relatedPosts = getRelatedPosts(slug, 3, lang);

// Parse markdown-like content into sections
const contentLines = post.content
  .split('\n')
  .filter((line) => line.trim())
  .map((line) => line.trim());
---

<PageLayout
  title={post.title}
  description={post.excerpt}
  lang={lang}
  keywords={post.tags}
  ogType="article"
>
  {/* Article Header */}
  <section class="relative overflow-hidden hero-gradient text-[#f0ebe0]">
    <div class="hero-pattern"></div>
    <div class="relative z-10 mx-auto max-w-4xl px-4 py-16 lg:py-24">
      <a
        href={getLocalizedPath('/blog', lang)}
        class="hero-animate inline-flex items-center gap-1 text-sm text-[#f0ebe0]/60 hover:text-primary transition mb-6"
      >
        ← {blogContent.backToBlog}
      </a>
      <span class="hero-animate hero-animate-delay-1 block text-xs font-semibold text-primary mb-3">{post.category}</span>
      <h1 class="hero-animate hero-animate-delay-1 text-3xl font-bold tracking-tight font-display sm:text-4xl lg:text-5xl">{post.title}</h1>
      <p class="hero-animate hero-animate-delay-2 mt-4 text-lg text-[#f0ebe0]/65">{post.excerpt}</p>
      <div class="hero-animate hero-animate-delay-2 mt-6 flex items-center gap-4 text-sm text-[#f0ebe0]/50">
        <span>{post.date}</span>
        <span>{post.readTime}</span>
      </div>
    </div>
  </section>

  {/* Article Content */}
  <section class="py-14 lg:py-20">
    <div class="mx-auto max-w-4xl px-4">
      <div class="grid gap-12 lg:grid-cols-[1fr_280px]">
        {/* Main content */}
        <article class="prose prose-lg max-w-none" data-animate="fade-in-up">
          {contentLines.map((line) => {
            if (line.startsWith('## ')) {
              return <h2 class="text-2xl font-bold font-display mt-8 mb-4">{line.replace('## ', '')}</h2>;
            }
            if (line.startsWith('### ')) {
              return <h3 class="text-xl font-semibold mt-6 mb-3">{line.replace('### ', '')}</h3>;
            }
            if (line.startsWith('**') && line.endsWith('**')) {
              return <p class="font-semibold mt-4">{line.replace(/\*\*/g, '')}</p>;
            }
            return <p class="text-muted-foreground leading-relaxed mb-4">{line}</p>;
          })}
        </article>

        {/* Sidebar */}
        <aside class="hidden lg:block space-y-8" data-animate="fade-in-up" data-animate-delay="200">
          {/* CTA */}
          <div class="rounded-xl border border-border bg-card p-6 shadow-sm sticky top-24">
            <h3 class="text-lg font-semibold mb-2 font-display">{blogContent.needRepairTitle}</h3>
            <p class="text-sm text-muted-foreground mb-4">{blogContent.needRepairText}</p>
            <a
              href={getLocalizedPath('/contact', lang)}
              class="block w-full rounded-lg gold-gradient gold-shimmer py-2.5 text-center text-sm font-semibold text-white shadow-md transition hover:shadow-lg hover:shadow-primary/20 mb-2"
            >
              {blogContent.requestService}
            </a>
            <a
              href="https://wa.me/966500000000"
              target="_blank"
              rel="noopener noreferrer"
              class="block w-full rounded-lg border border-primary/30 py-2.5 text-center text-sm font-semibold text-primary transition hover:bg-primary/5"
            >
              {blogContent.chatWhatsApp}
            </a>
          </div>

          {/* Quick Links */}
          <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
            <h3 class="text-sm font-semibold mb-3 font-display">{blogContent.quickLinks}</h3>
            <ul class="space-y-2">
              {blogContent.quickLinkItems.map((link) => (
                <li>
                  <a
                    href={getLocalizedPath(link.href, lang)}
                    class="text-sm text-muted-foreground hover:text-primary transition"
                  >
                    {link.name}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </section>

  {/* Related Posts */}
  {relatedPosts.length > 0 && (
    <section class="py-14 lg:py-20 bg-secondary/40">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl font-bold font-display mb-2" data-animate="fade-in-up">{blogContent.relatedArticles}</h2>
        <p class="text-muted-foreground mb-8" data-animate="fade-in-up">{blogContent.continueDescription}</p>
        <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
          {relatedPosts.map((rp, i) => (
            <a
              href={getLocalizedPath(`/blog/${rp.slug}`, lang)}
              class="group rounded-xl border border-border bg-card shadow-sm transition-all duration-300 hover:shadow-lg hover:border-primary/30 overflow-hidden card-hover-lift"
              data-animate="fade-in-up" data-animate-delay={String(i * 100)}
            >
              <div class="aspect-video overflow-hidden bg-muted blog-card-image">
                <img
                  src={rp.image}
                  alt={rp.imageAlt}
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                  width="400"
                  height="225"
                />
              </div>
              <div class="p-5">
                <span class="text-xs font-semibold text-primary">{rp.category}</span>
                <h3 class="mt-2 text-base font-semibold font-display line-clamp-2">{rp.title}</h3>
                <span class="mt-2 inline-flex items-center gap-1 text-sm font-medium text-primary group-hover:gap-2 transition-all">{blogContent.readArticle} →</span>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</PageLayout>
