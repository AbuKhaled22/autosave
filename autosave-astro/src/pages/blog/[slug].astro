---
import PageLayout from '../../layouts/PageLayout.astro';
import BlogPostContent from '../../components/blog/BlogPostContent.astro';
import BlogPostSchema from '../../components/blog/BlogPostSchema.astro';
import BlogSidebar from '../../components/blog/BlogSidebar.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import { getContentByLanguage } from '../../lib/content';
import { getLocalizedPath } from '../../lib/i18n';
import { blogPosts, getBlogPost, getRelatedPosts } from '../../lib/blog-data';

const lang = 'ar' as const;
const content = getContentByLanguage(lang);
const blogContent = content.blog.post;

export function getStaticPaths() {
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = getBlogPost(slug, lang);

if (!post) {
  return Astro.redirect('/404');
}

const relatedPosts = getRelatedPosts(slug, 3, lang);
const canonicalUrl = Astro.url.href;

const sanitizeMoney = (text: string) =>
  text
    .replace(/\$\s*\d[\d,]*(?:\s*-\s*\$?\d[\d,]*)?/g, 'حسب الفحص')
    .replace(/\d[\d,]*(?:\s*-\s*\d[\d,]*)?\s*(?:\+)?\s*(?:SAR|ريال(?:\s+سعودي)?|ر\.س)/gi, 'حسب الفحص');

const formattedDate = new Date(post.date).toLocaleDateString('ar-SA', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<PageLayout
  title={post.title}
  description={sanitizeMoney(post.excerpt)}
  lang={lang}
  keywords={post.tags}
  ogType="article"
>
  {/* BlogPosting JSON-LD schema */}
  <BlogPostSchema post={post} lang={lang} canonicalUrl={canonicalUrl} />

  {/* Article wrapper */}
  <article>
    {/* Article Header */}
    <header class="relative overflow-hidden hero-gradient text-[#f0ebe0]">
      <div class="hero-pattern"></div>
      <div class="relative z-10 mx-auto max-w-4xl px-4 py-16 lg:py-24">
        <a
          href={getLocalizedPath('/blog', lang)}
          class="hero-animate inline-flex items-center gap-1 text-sm text-[#f0ebe0]/60 hover:text-primary transition mb-6"
          aria-label={blogContent.backToBlog}
        >
          <svg class="h-4 w-4 rtl:-scale-x-100 rotate-180" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
          {blogContent.backToBlog}
        </a>
        <div class="hero-animate hero-animate-delay-1 flex flex-wrap items-center gap-3 mb-4">
          <span class="rounded-full gold-gradient px-3 py-1 text-xs font-semibold text-white">{post.category}</span>
          <span class="flex items-center gap-1.5 text-sm text-[#f0ebe0]/60">
            <svg class="h-3.5 w-3.5" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
            <time datetime={post.date}>{formattedDate}</time>
          </span>
          <span class="flex items-center gap-1.5 text-sm text-[#f0ebe0]/60">
            <svg class="h-3.5 w-3.5" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            {post.readTime}
          </span>
        </div>
        <h1 class="hero-animate hero-animate-delay-1 text-3xl font-bold tracking-tight font-display sm:text-4xl lg:text-5xl">{post.title}</h1>
        <p class="hero-animate hero-animate-delay-2 mt-4 text-lg text-[#f0ebe0]/65">{sanitizeMoney(post.excerpt)}</p>
      </div>
    </header>

    {/* Featured Image */}
    <div class="relative -mt-1 aspect-[21/9] w-full overflow-hidden bg-[#1a1612]">
      <img
        src={post.image}
        alt={post.imageAlt}
        class="h-full w-full object-cover"
        width="1200"
        height="514"
        loading="eager"
        fetchpriority="high"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-[var(--color-background)]/20 to-transparent"></div>
    </div>

    {/* Article Content + Sidebar */}
    <section class="py-14 lg:py-20">
      <div class="mx-auto max-w-4xl px-4">
        <div class="grid gap-12 lg:grid-cols-[1fr_280px]">
          {/* Main content */}
          <div class="prose prose-lg max-w-none" data-animate="fade-in-up">
            <BlogPostContent content={post.content} />

            {/* Tags */}
            <footer class="mt-16 border-t border-border pt-8">
              <div class="flex flex-wrap items-center gap-2" role="list" aria-label={lang === 'ar' ? 'الوسوم' : 'Tags'}>
                <svg class="h-4 w-4 text-muted-foreground" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
                {post.tags.map((tag) => (
                  <span class="rounded-full border border-border px-3 py-1 text-xs text-muted-foreground" role="listitem">{tag}</span>
                ))}
              </div>
            </footer>
          </div>

          {/* Sidebar */}
          <BlogSidebar lang={lang} blogContent={blogContent} relatedPosts={relatedPosts} />
        </div>
      </div>
    </section>
  </article>

  {/* Continue Reading */}
  {relatedPosts.length > 0 && (
    <section class="py-14 lg:py-20 bg-secondary/40">
      <div class="container mx-auto px-4">
        <div class="text-center mb-10" data-animate="fade-in-up">
          <h2 class="text-2xl font-bold font-display">{blogContent.continueReading}</h2>
          <p class="mt-2 text-muted-foreground">{blogContent.continueDescription}</p>
        </div>
        <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
          {relatedPosts.map((rp, i) => (
            <BlogCard
              post={rp}
              lang={lang}
              readMoreLabel={blogContent.readArticle}
              animateDelay={String(i * 100)}
            />
          ))}
        </div>
      </div>
    </section>
  )}
</PageLayout>
